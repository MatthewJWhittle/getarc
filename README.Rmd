  
---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->
# getarc
  <!-- badges: start -->
  [![Codecov test coverage](https://codecov.io/gh/MatthewJWhittle/getarc/branch/master/graph/badge.svg)](https://codecov.io/gh/MatthewJWhittle/getarc?branch=master)
  
  <!-- badges: end -->

# Overview
`getarc` is an R wrapper for the [ArcGIS Rest API](https://developers.arcgis.com/rest/services-reference/). It provides access to the extensive open data available from [Arc GIS](https://hub.arcgis.com/search).
It currently only supports functionality for querying data. 

* `query_layer` gets data from an arc gis server and supports query operations
* `get_layer_details` gets metadata about a layer such as the field names and maxRecordCount
* `get_token` gets an access token via a web browser login to access private services

# Installation
The package can currently be installed from github:
```{r eval=FALSE}
# Install the development version from GitHub:
install.packages("devtools")
devtools::install_github("matthewjwhittle/getarc")
```
```{r include=FALSE}
devtools::load_all()
```

# Examples
```{r warning=FALSE, message=FALSE}
library(getarc)
library(sf)
library(tidyverse)
```

# Getting data
Data on an arc gis server can be accessed via the `query_layer` function. This function also supports any query operation supported by the ArcGIS Rest API.

# Getting data from a Feature Server - National Parks in England
```{r cache=T}
# Define the endpoint URL
parks_endpoint <- "https://services.arcgis.com//JJzESW51TqeY9uat/arcgis/rest/services/National_Parks_England/FeatureServer/0"
# Get the data
national_parks <- 
  query_layer(endpoint = parks_endpoint)

head(national_parks)
# Plot the first feature
plot(national_parks$geometry[1])
```

## Querys
A query can be included in the request by either supplying a named list to the `query` parameter, or passing a bounding box to `bounding_box` to return intersecting features.

The query parameter supports any query parameter supported by the API Please review the [API documentation](https://developers.arcgis.com/rest/services-reference/query-feature-service-layer-.htm) on querying Feature Server layers for detail on how to query data. I intend to provide more R-friendly support for query operations in the future.

Returning only one feature.
```{r}
one_park <- 
  query_layer(endpoint = parks_endpoint,
  # Return only one record
  query = c(resultRecordCount = 1)
)
print(one_park)
plot(one_park$geometry)

# Including a sql where query to only return the yorkshire dales
yorkshire_dales <- 
  query_layer(endpoint = parks_endpoint,
  # SQL query to return data for the yorkshire dales 
  query = c("where" = "NAME='YORKSHIRE DALES'")
)
```

Spatial querys can be perform either via the `query` argument or by passing a bounding box to the `bounding_box` argument. This will perform a spatial query and return only features intersecting with the bounding box. I intend to add support for more advanced query operations in the future.

```{r cache = TRUE}
dales_bbox <- st_bbox(yorkshire_dales)

# Which Sites of Special Scientific Interest are in the yorkshire dales?
sssi_endpoint <- "https://services.arcgis.com//JJzESW51TqeY9uat/arcgis/rest/services/SSSI_England/FeatureServer/0"
dales_sssi <- 
  query_layer(sssi_endpoint, 
  # Supply a bounding box for a spatial intersects query
  bounding_box = dales_bbox
)

# Transform the data for plotting
yorkshire_dales <- yorkshire_dales %>% st_transform(crs = 27700)
dales_sssi <- dales_sssi %>% st_transform(crs = 27700)

# Plot the yorkshire dales and it's SSSIs
plot(yorkshire_dales$geometry)
plot(dales_sssi$geometry, add = TRUE, border = "red", col = "orange")
```

# Endpoints 
The endpoint url can be copied from Query URL box of th Arc GIS API explorer, or created using the `feature_server_endpoint` or `map_server_endpoint` functions.

Both `feature_server_endpoint` and `map_server_endpoint`  work in the same way. The key difference is that resources on feature servers are defined using a `feature_server` parameter and map servers accept a `folder` and `layer_name` argument.

```{r}
national_parks_endpoint <- 
  feature_server_endpoint(
  host = "https://services.arcgis.com/",
  instance = "JJzESW51TqeY9uat",
  feature_server = "National_Parks_England",
  layer_id = 0
)
postcodes_endpoint <- 
  map_server_endpoint(
  host = "https://ons-inspire.esriuk.com",
  instance = "arcgis",
  folder = "Postcodes",
  service_name = "ONS_Postcode_Directory_Latest_Centroids",
  layer_id = 0
)

query_layer(postcodes_endpoint, 
            query = c(maxRecordCount = 1))
```

# Authentication
Authentication is done via oauth2.0 and the `get_token` function. Sign in is done via a popup browser window and the token can be passed to the query functions via the `my_token` argument.
```{r, eval=FALSE}
my_token <- get_token()

data <-
  query_layer(endpoint = private_endpoint,
  # Pass in token for a private service
  my_token = my_token
)
```



